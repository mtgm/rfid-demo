<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>RFID 3D Konfigüratör</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#0b0d12;color:#e9eef5;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;display:flex;flex-direction:column;min-height:100vh}
    header{padding:10px 16px;border-bottom:1px solid #1d2230;background:#0f121a;display:flex;align-items:center;gap:16px}
    header h1{font-size:16px;margin:0;font-weight:600}
    #viewer{flex:1;position:relative;min-height:320px}
    #canvasContainer{position:absolute;inset:0}
    .toolbar{padding:12px 16px;border-top:1px solid #1d2230;background:#0f121a;display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px dashed #2a3650;border-radius:8px;padding:8px 10px;background:#0b0f1a}
    .btn{border:1px solid #2a3650;background:#111827;color:#e9eef5;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn:hover{background:#172036}
    .input{border:1px solid #2a3650;background:#0b0f1a;color:#e9eef5;padding:6px 10px;border-radius:6px}
    .diag{position:absolute;left:12px;bottom:12px;background:rgba(15,18,26,.9);border:1px solid #2a3650;border-radius:6px;padding:6px 10px;font-size:12px;max-width:80vw;white-space:pre-wrap}
  </style>

  <!-- Import map: 'three' adını CDN'e eşle -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js?v=11"
    }
  }
  </script>
</head>
<body>
  <header><h1>RFID 3D Konfigüratör</h1></header>

  <div id="viewer">
    <div id="canvasContainer"></div>
    <div id="diag" class="diag">Hazır.</div>
  </div>

  <div class="toolbar">
    <div class="card">
      <div>UID Girişi</div>
      <input id="uidInput" class="input" placeholder="ör. 0001234567" />
      <button id="applyUid" class="btn">Uygula</button>
    </div>
    <div class="card">
      <div>ALT PANEL</div>
      <button class="btn" data-part="alt_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="alt_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="alt_panel" data-mat="white">Beyaz</button>
    </div>
    <div class="card">
      <div>ÜST PANEL</div>
      <button class="btn" data-part="ust_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="ust_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="ust_panel" data-mat="white">Beyaz</button>
    </div>
    <div class="card">
      <div>SOL PANEL</div>
      <button class="btn" data-part="sol_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="sol_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="sol_panel" data-mat="white">Beyaz</button>
    </div>
    <div class="card">
      <div>SAĞ PANEL</div>
      <button class="btn" data-part="sag_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="sag_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="sag_panel" data-mat="white">Beyaz</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js?v=11";
    import { MeshoptDecoder } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/libs/meshopt_decoder.module.js?v=11";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js?v=11";

    // ====== AYARLAR ======
    const MODEL_PATH = "assets/model.glb?v=11";   // gerekirse dolap.glb/dolap_v1.glb yap
    const PART_KEYS = {                           // ad ya da material.name içinde bunlar geçerse eşle
      alt_panel: ["alt_panel","alt"],
      ust_panel: ["ust_panel","üst","ust"],
      sol_panel: ["sol_panel","sol","left"],
      sag_panel: ["sag_panel","sağ","sag","right"]
    };
    const MATERIAL_TEXTURES = {
      walnut: "textures/walnut.jpg",
      oak:    "textures/oak.jpg",
      white:  "textures/white.jpg"
    };
    const MATERIAL_COLORS = { walnut:0x8b5a2b, oak:0xb88a55, white:0xeeeeee }; // doku yoksa fallback

    // ====== SAHNE ======
    let scene, camera, renderer, controls, root;
    const container = document.getElementById('canvasContainer');
    const diagEl = document.getElementById('diag');
    const partTargets = { alt_panel:[], ust_panel:[], sol_panel:[], sag_panel:[] };
    const log = (m)=>{ diagEl.textContent = m; console.log(m); };

    init3D();
    await loadModel();
    animate();

    function init3D(){
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0d12);

      const {w,h} = size();
      camera = new THREE.PerspectiveCamera(50, w/h, 0.01, 5000);
      camera.position.set(0, 1.2, 3);

      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
      renderer.setSize(w, h);
      container.appendChild(renderer.domElement);

      // Işıklar (önce konumlandır, sonra sahneye ekle)
      const d1 = new THREE.DirectionalLight(0xffffff, 1.0);
      d1.position.set(3,4,5);
      scene.add(d1);
      scene.add(new THREE.AmbientLight(0xffffff, 0.55));

      // Orbit Controls (zoom/pan/rotate)
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.minDistance = 0.2;
      controls.maxDistance = 50;
      controls.target.set(0,0,0);

      window.addEventListener('resize', onResize);
    }

    function size(){
      const r = container.getBoundingClientRect();
      return { w: r.width || window.innerWidth, h: r.height || (window.innerHeight - 180) };
    }

    function animate(){
      requestAnimationFrame(animate);
      controls && controls.update();
      renderer.render(scene,camera);
    }

    async function loadModel(){
      try{
        log("Model yükleniyor…");
        const loader = new GLTFLoader();
        loader.setMeshoptDecoder(MeshoptDecoder); // Meshopt sıkıştırma için gerekli

        const gltf = await loader.loadAsync(MODEL_PATH);
        root = gltf.scene;
        scene.add(root);

        // Orijin merkezleme + kadraj
        centerAndFrame(root);

        // Parça gruplarını topla; malzemeleri klonla ki bağımsız değişsin
        root.traverse(obj=>{
          if (!obj.isMesh) return;
          const name = (obj.name||"").toLowerCase();
          const matName = (obj.material?.name||"").toLowerCase();
          obj.material = Array.isArray(obj.material) ? obj.material.map(m=>m.clone()) : obj.material.clone();
          for (const key in PART_KEYS){
            if (PART_KEYS[key].some(k=> name.includes(k) || matName.includes(k))) {
              partTargets[key].push(obj);
            }
          }
        });

        // Başlangıç: beyaz
        await applyPart("alt_panel","white");
        await applyPart("ust_panel","white");
        await applyPart("sol_panel","white");
        await applyPart("sag_panel","white");

        log("Hazır.");
      }catch(e){ log("MODEL YÜKLENEMEDİ → "+e.message); }
    }

    function centerAndFrame(object){
      // 1) modeli orijine al
      const box = new THREE.Box3().setFromObject(object);
      const center = box.getCenter(new THREE.Vector3());
      object.position.sub(center);

      // 2) kamerayı uygun mesafeye çek ve hedefi sıfıra koy
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      const fitOffset = 1.6;
      const fov = THREE.MathUtils.degToRad(camera.fov);
      const dist = (maxDim / (2 * Math.tan(fov / 2))) * fitOffset;

      camera.position.set(0, 0, dist);
      camera.near = dist/50; camera.far = dist*50; camera.updateProjectionMatrix();
      controls.target.set(0,0,0);
      controls.update();
    }

    function onResize(){
      const {w,h} = size();
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w,h);
      controls && controls.update();
      // model çerçevesi sabit kalsın istiyorsan, uncomment:
      // if (root) centerAndFrame(root);
    }

    // ====== DOKU YÜKLEYİCİ ======
    const textureCache = new Map();
    function loadTexture(url){
      return new Promise((resolve,reject)=>{
        if (textureCache.has(url)) return resolve(textureCache.get(url));
        new THREE.TextureLoader().load(url, (tx)=>{
          tx.wrapS = THREE.RepeatWrapping; tx.wrapT = THREE.RepeatWrapping;
          tx.repeat.set(2,2);
          tx.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy()||8);
          textureCache.set(url, tx);
          resolve(tx);
        }, undefined, ()=>reject(new Error("Doku yüklenemedi: "+url)));
      });
    }

    async function buildMaterialFromKey(key){
      const path = MATERIAL_TEXTURES[key];
      if (path){
        try{
          const tx = await loadTexture(path);
          return new THREE.MeshStandardMaterial({ map: tx, roughness:0.6, metalness:0.05 });
        }catch(e){
          log(e.message + " → renk fallback");
        }
      }
      const color = MATERIAL_COLORS[key] || 0xcccccc;
      return new THREE.MeshStandardMaterial({ color, roughness:0.6, metalness:0.05 });
    }

    async function applyPart(partKey, matKey){
      const targets = partTargets[partKey] || [];
      if (!targets.length){ log(partKey+" için mesh bulunamadı."); return; }
      const mat = await buildMaterialFromKey(matKey);
      targets.forEach(m => { m.material = mat; m.material.needsUpdate = true; });
      log(`${partKey} → ${matKey}`);
    }

    // UI
    document.querySelectorAll('button[data-part]').forEach(btn=>{
      btn.addEventListener('click', ()=> applyPart(btn.dataset.part, btn.dataset.mat));
    });
    document.getElementById('applyUid').addEventListener('click', ()=>{
      const uid = document.getElementById('uidInput').value.trim();
      if (!uid) return;
      // örnek: UID ile toplu atama yapabilirsin
      if (uid === "0001234567") applyPart("alt_panel","walnut");
    });
  </script>
</body>
</html>
