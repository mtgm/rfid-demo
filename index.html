<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>RFID 3D Konfigüratör (Import Map + Otomatik Kadraj)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --hdr-h:64px; --tlb-h:120px; --bg:#0b0d12; --panel:#0b0f1a; --line:#1d2230; --ink:#e9eef5; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .app{display:flex;flex-direction:column;min-height:100vh}
    header{height:var(--hdr-h);padding:12px 16px;border-bottom:1px solid var(--line);background:#0f121a;display:flex;align-items:center;gap:16px}
    header h1{font-size:18px;margin:0;font-weight:600}
    .spacer{flex:1}
    .panel{padding:6px 10px;border:1px solid #2a3650;border-radius:8px;background:var(--panel)}
    .kbd{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace;font-size:12px;padding:2px 6px;border:1px solid #2a3650;border-bottom-width:2px;border-radius:6px;background:var(--panel)}
    label{font-size:12px;opacity:.8}
    #viewer{position:relative;flex:1 1 auto;min-height:320px;overflow:hidden}
    #canvasContainer{position:absolute;inset:0}
    .toolbar{position:relative;z-index:10;display:flex;gap:12px;align-items:flex-start;padding:12px 16px;border-top:1px solid var(--line);background:#0f121a;min-height:var(--tlb-h);flex-wrap:wrap}
    .input{border:1px solid #2a3650;background:var(--panel);color:var(--ink);border-radius:10px;padding:8px 10px}
    .btn{border:1px solid #2a3650;background:#111827;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px}
    .btn:hover{background:#172036}
    .card{border:1px dashed #2a3650;border-radius:10px;padding:8px 10px;background:var(--panel)}
    .col{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .title{font-weight:600;margin-bottom:6px}
    .diagBox{position:absolute;left:12px;bottom:12px;background:rgba(15,18,26,.9);border:1px solid #2a3650;border-radius:10px;padding:8px 10px;font-size:12px;max-width:min(600px,90vw);white-space:pre-wrap}
  </style>

  <!-- IMPORT MAP: 'three' adını CDN'e eşliyoruz -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js?v=8"
    }
  }
  </script>
</head>
<body>
  <div class="app">
    <header>
      <h1>RFID 3D Konfigüratör</h1>
      <div class="spacer"></div>
      <div class="panel"><div><label>Son UID</label></div><div id="uid" class="kbd">—</div></div>
      <div class="panel"><div><label>Durum</label></div><div id="diag" class="kbd">—</div></div>
    </header>

    <div id="viewer">
      <div id="canvasContainer"></div>
      <div id="diagBox" class="diagBox">Hazır.</div>
    </div>

    <div class="toolbar">
      <div class="card">
        <div class="title">UID Girişi</div>
        <input id="uidInput" class="input" placeholder="ör. 0001234567" />
        <button id="applyUid" class="btn">Uygula</button>
      </div>

      <div class="card">
        <div class="title">ALT PANEL</div>
        <div class="col">
          <button class="btn" data-part="alt_panel" data-mat="walnut">Ceviz</button>
          <button class="btn" data-part="alt_panel" data-mat="oak">Meşe</button>
          <button class="btn" data-part="alt_panel" data-mat="white">Beyaz</button>
        </div>
      </div>

      <div class="card">
        <div class="title">ÜST PANEL</div>
        <div class="col">
          <button class="btn" data-part="ust_panel" data-mat="walnut">Ceviz</button>
          <button class="btn" data-part="ust_panel" data-mat="oak">Meşe</button>
          <button class="btn" data-part="ust_panel" data-mat="white">Beyaz</button>
        </div>
      </div>

      <div class="card">
        <div class="title">SOL PANEL</div>
        <div class="col">
          <button class="btn" data-part="sol_panel" data-mat="walnut">Ceviz</button>
          <button class="btn" data-part="sol_panel" data-mat="oak">Meşe</button>
          <button class="btn" data-part="sol_panel" data-mat="white">Beyaz</button>
        </div>
      </div>

      <div class="card">
        <div class="title">SAĞ PANEL</div>
        <div class="col">
          <button class="btn" data-part="sag_panel" data-mat="walnut">Ceviz</button>
          <button class="btn" data-part="sag_panel" data-mat="oak">Meşe</button>
          <button class="btn" data-part="sag_panel" data-mat="white">Beyaz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Module script: YALNIZCA 'three' ismi kullanılıyor; haritayı import map çözüyor -->
  <script type="module">
    import * as THREE from "three";
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js?v=8";

    // === AYARLAR ===
    const MODEL_PATH = "assets/model.glb?v=8"; // gerekirse dolap.glb/dolap_v1.glb yap
    const PART_KEYS = {
      alt_panel: ["alt_panel"],
      ust_panel: ["ust_panel"],
      sol_panel: ["sol_panel"],
      sag_panel: ["sag_panel"]
    };
    const MATERIAL_TEXTURES = {
      walnut: "textures/walnut.jpg",
      oak:    "textures/oak.jpg",
      white:  "textures/white.jpg"
    };
    const MATERIAL_COLORS = { walnut:0x8b5a2b, oak:0xb88a55, white:0xeeeeee };
    const UID_TO_ASSIGN = {
      "0001234567": { alt_panel:"walnut" },
      "0002345678": { ust_panel:"oak"    },
      "0003456789": { sol_panel:"white", sag_panel:"walnut" }
    };

    // === SAHNE ===
    let scene, camera, renderer, root;
    const container = document.getElementById('canvasContainer');
    const uidDiv = document.getElementById('uid');
    const diagDiv = document.getElementById('diag');
    const diagBox = document.getElementById('diagBox');
    const partTargets = { alt_panel:[], ust_panel:[], sol_panel:[], sag_panel:[] };
    const log = (m)=>{ diagDiv.textContent = m; diagBox.textContent = m; console.log(m); };

    init3D();
    await loadModel();
    animate();

    function init3D(){
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0d12);

      const {w,h} = viewportSize();
      camera = new THREE.PerspectiveCamera(50, w/h, 0.01, 5000);
      camera.position.set(0, 1.2, 3);

      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
      renderer.setSize(w, h);
      container.appendChild(renderer.domElement);

      const l1 = new THREE.DirectionalLight(0xffffff, 1.0); l1.position.set(3,4,5); scene.add(l1);
      const l2 = new THREE.AmbientLight(0xffffff, 0.55);    scene.add(l2);

      let drag=false, px=0, py=0;
      container.addEventListener('mousedown', e=>{drag=true;px=e.clientX;py=e.clientY;});
      window.addEventListener('mouseup', ()=>drag=false);
      window.addEventListener('mousemove', e=>{
        if(!drag || !root) return;
        const dx=e.clientX-px, dy=e.clientY-py; px=e.clientX; py=e.clientY;
        root.rotation.y += dx*0.01; root.rotation.x += dy*0.01;
      });

      window.addEventListener('resize', refitOnResize);
    }

    function viewportSize(){
      const r = container.getBoundingClientRect();
      return { w: r.width || window.innerWidth, h: r.height || (window.innerHeight - 156) };
    }

    function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }

    async function loadModel(){
      try{
        log("Model yükleniyor: " + MODEL_PATH);
        const gltf = await new GLTFLoader().loadAsync(MODEL_PATH);
        root = gltf.scene;
        scene.add(root);

        // parçaları topla + malzeme klonla
        root.traverse(obj=>{
          if (!obj.isMesh) return;
          const name = (obj.name||"").toLowerCase();
          const matName = (obj.material?.name||"").toLowerCase();
          obj.material = Array.isArray(obj.material) ? obj.material.map(m=>m.clone()) : obj.material.clone();
          for (const part in PART_KEYS){
            if (PART_KEYS[part].some(k => name.includes(k) || matName.includes(k))) partTargets[part].push(obj);
          }
        });

        centerAndFrame(root);

        // başlangıç: beyaz
        await applyPart("alt_panel","white");
        await applyPart("ust_panel","white");
        await applyPart("sol_panel","white");
        await applyPart("sag_panel","white");
        log("Hazır.");
      }catch(err){
        log("MODEL YÜKLENEMEDİ → " + err.message);
      }
    }

    // merkezleme + kadraj
    function centerAndFrame(object){
      const box = new THREE.Box3().setFromObject(object);
      const center = box.getCenter(new THREE.Vector3());
      object.position.sub(center);

      const box2 = new THREE.Box3().setFromObject(object);
      const size = box2.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      const fitOffset = 1.6;
      const fov = THREE.MathUtils.degToRad(camera.fov);
      const distance = (maxDim / (2 * Math.tan(fov / 2))) * fitOffset;

      camera.position.set(0, 0, distance);
      camera.near = distance / 50;
      camera.far  = distance * 50;
      camera.updateProjectionMatrix();
      camera.lookAt(0, 0, 0);
    }

    function refitOnResize(){
      const {w,h} = viewportSize();
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
      if (root) centerAndFrame(root);
    }

    // dokular
    const textureCache = new Map();
    function loadTexture(url){
      return new Promise((resolve,reject)=>{
        if (textureCache.has(url)) return resolve(textureCache.get(url));
        new THREE.TextureLoader().load(url, tx=>{ tx.wrapS=tx.wrapT=THREE.RepeatWrapping; tx.repeat.set(2,2);
          tx.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy()||8);
          textureCache.set(url, tx); resolve(tx);
        }, undefined, ()=>reject(new Error("Doku yüklenemedi: "+url)));
      });
    }
    async function buildMaterialFromKey(key){
      const path = MATERIAL_TEXTURES[key];
      if (path){
        try{ const tx = await loadTexture(path);
          return new THREE.MeshStandardMaterial({ map: tx, roughness:0.6, metalness:0.05 });
        }catch(e){ log(e.message+" → renk fallback"); }
      }
      const color = MATERIAL_COLORS[key]||0xcccccc;
      return new THREE.MeshStandardMaterial({ color, roughness:0.6, metalness:0.05 });
    }

    async function applyPart(partKey, matKey){
      const targets = partTargets[partKey] || [];
      const mat = await buildMaterialFromKey(matKey);
      targets.forEach(m => { m.material = mat; m.material.needsUpdate = true; });
      log(`${partKey} → ${matKey}`);
    }

    // butonlar
    document.querySelectorAll('button.btn[data-part]').forEach(btn=>{
      btn.addEventListener('click', ()=> applyPart(btn.dataset.part, btn.dataset.mat));
    });

    // UID simülasyonu
    function applyUid(uidRaw){
      const uid = (uidRaw||"").trim(); if(!uid) return;
      uidDiv.textContent = uid;
      const assign = UID_TO_ASSIGN[uid];
      if (!assign) return;
      for (const part in assign){ const key = assign[part]; if (key) applyPart(part, key); }
    }
    document.getElementById('applyUid').addEventListener('click', ()=>{
      applyUid(document.getElementById('uidInput').value);
    });
  </script>
</body>
</html>
