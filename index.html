<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>RFID 3D Konfigüratör</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#f3f0ea;color:#0b0d12;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;display:flex;flex-direction:column;min-height:100vh}
    header{padding:10px 16px;border-bottom:1px solid #d9d2c7;background:#ffffffcc;backdrop-filter:saturate(1.2) blur(2px);display:flex;align-items:center;gap:16px}
    header h1{font-size:16px;margin:0;font-weight:600}
    #viewer{flex:1;position:relative;min-height:360px}
    #canvasContainer{position:absolute;inset:0}
    .toolbar{padding:12px 16px;border-top:1px solid #d9d2c7;background:#ffffffcc;backdrop-filter:saturate(1.2) blur(2px);display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px dashed #c7b9a4;border-radius:10px;padding:8px 10px;background:#fff}
    .btn{border:1px solid #c7b9a4;background:#fff;color:#2b2b2b;padding:6px 10px;border-radius:8px;cursor:pointer}
    .btn:hover{background:#f4efe8}
    .input{border:1px solid #c7b9a4;background:#fff;color:#2b2b2b;padding:6px 10px;border-radius:8px}
    .diag{position:absolute;left:12px;bottom:12px;background:#ffffffdd;border:1px solid #c7b9a4;border-radius:8px;padding:6px 10px;font-size:12px;max-width:80vw;white-space:pre-wrap}
  </style>

  <!-- Import map: 'three' adını CDN'e eşle -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js?v=12"
    }
  }
  </script>
</head>
<body>
  <header><h1>RFID 3D Konfigüratör</h1></header>

  <div id="viewer">
    <div id="canvasContainer"></div>
    <div id="diag" class="diag">Hazır.</div>
  </div>

  <div class="toolbar">
    <div class="card">
      <div>UID Girişi</div>
      <input id="uidInput" class="input" placeholder="ör. 0001234567" />
      <button id="applyUid" class="btn">Uygula</button>
    </div>
    <div class="card">
      <div>ALT PANEL</div>
      <button class="btn" data-part="alt_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="alt_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="alt_panel" data-mat="white">Beyaz</button>
    </div>
    <div class="card">
      <div>ÜST PANEL</div>
      <button class="btn" data-part="ust_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="ust_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="ust_panel" data-mat="white">Beyaz</button>
    </div>
    <div class="card">
      <div>SOL PANEL</div>
      <button class="btn" data-part="sol_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="sol_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="sol_panel" data-mat="white">Beyaz</button>
    </div>
    <div class="card">
      <div>SAĞ PANEL</div>
      <button class="btn" data-part="sag_panel" data-mat="walnut">Ceviz</button>
      <button class="btn" data-part="sag_panel" data-mat="oak">Meşe</button>
      <button class="btn" data-part="sag_panel" data-mat="white">Beyaz</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js?v=12";
    import { MeshoptDecoder } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/libs/meshopt_decoder.module.js?v=12";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js?v=12";

    // ====== AYARLAR ======
    const MODEL_PATH = "assets/model.glb?v=12";   // gerekirse dolap.glb/dolap_v1.glb yap
    // Parça eşleşme anahtarları (mesh adı veya material adı)
    const PART_KEYS = {
      alt_panel: ["alt_panel","alt","bottom","base"],
      ust_panel: ["ust_panel","ust","üst","top","kapak"],
      sol_panel: ["sol_panel","sol","left"],
      sag_panel: ["sag_panel","sag","sağ","right"]
    };
    // Doku yolları (varsa kullanılır; yoksa renk fallback)
    const MATERIAL_TEXTURES = {
      walnut: "textures/walnut.jpg",
      oak:    "textures/oak.jpg",
      white:  "textures/white.jpg"
    };
    const MATERIAL_COLORS = { walnut:0x8b5a2b, oak:0xb88a55, white:0xeeeeee };

    // Parça bazlı “desen ölçeği ve yön” ayarı
    // repeat küçüldükçe desen büyür. rotDeg: 0 ya da 90 tipik yeter.
    const TEX_TWEAK = {
      alt_panel: { repeat:[0.28,0.28], rotDeg: 0  },
      ust_panel: { repeat:[0.28,0.28], rotDeg: 0  },
      sol_panel: { repeat:[0.28,0.28], rotDeg: 0 },
      sag_panel: { repeat:[0.28,0.28], rotDeg: 0 }
    };

    // ====== SAHNE ======
    let scene, camera, renderer, controls, root;
    const container = document.getElementById('canvasContainer');
    const diagEl = document.getElementById('diag');
    const partTargets = { alt_panel:[], ust_panel:[], sol_panel:[], sag_panel:[] };
    const log = (m)=>{ diagEl.textContent = m; console.log(m); };

    init3D();
    await loadModel();
    animate();

    function init3D(){
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf3f0ea); // açık bej/beyaz arkaplan

      const {w,h} = size();
      camera = new THREE.PerspectiveCamera(50, w/h, 0.01, 5000);
      camera.position.set(0, 1.2, 3);

      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
      renderer.setSize(w, h);
      container.appendChild(renderer.domElement);

      // Işıklar (doğru ekleme)
      const d1 = new THREE.DirectionalLight(0xffffff, 1.0);
      d1.position.set(3,4,5);
      scene.add(d1);
      const amb = new THREE.AmbientLight(0xffffff, 0.55);
      scene.add(amb);

      // Orbit Controls (zoom/pan/rotate)
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.minDistance = 0.25;
      controls.maxDistance = 50;
      controls.zoomSpeed = 1.0;
      controls.rotateSpeed = 0.8;
      controls.panSpeed = 0.6;

      window.addEventListener('resize', onResize);
    }

    function size(){
      const r = container.getBoundingClientRect();
      return { w: r.width || window.innerWidth, h: r.height || (window.innerHeight - 180) };
    }

    function animate(){
      requestAnimationFrame(animate);
      controls && controls.update();
      renderer.render(scene,camera);
    }

    async function loadModel(){
      try{
        log("Model yükleniyor…");
        const loader = new GLTFLoader();
        loader.setMeshoptDecoder(MeshoptDecoder); // Meshopt sıkıştırma için

        const gltf = await loader.loadAsync(MODEL_PATH);
        root = gltf.scene;
        scene.add(root);

        centerAndFrame(root);

        // Parça gruplarını topla; malzemeleri klonla
        root.traverse(obj=>{
          if (!obj.isMesh) return;
          const name = (obj.name||"").toLowerCase();
          const matName = (obj.material?.name||"").toLowerCase();
          obj.material = Array.isArray(obj.material) ? obj.material.map(m=>m.clone()) : obj.material.clone();
          for (const key in PART_KEYS){
            if (PART_KEYS[key].some(k=> name.includes(k) || matName.includes(k))) {
              partTargets[key].push(obj);
            }
          }
        });

        // Başlangıç: beyaz
        await applyPart("alt_panel","white");
        await applyPart("ust_panel","white");
        await applyPart("sol_panel","white");
        await applyPart("sag_panel","white");

        log("Hazır.");
      }catch(e){ log("MODEL YÜKLENEMEDİ → "+e.message); }
    }

    function centerAndFrame(object){
      const box = new THREE.Box3().setFromObject(object);
      const center = box.getCenter(new THREE.Vector3());
      object.position.sub(center);

      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      const fitOffset = 1.6;
      const fov = THREE.MathUtils.degToRad(camera.fov);
      const dist = (maxDim / (2 * Math.tan(fov / 2))) * fitOffset;

      camera.position.set(0, 0, dist);
      camera.near = dist/50; camera.far = dist*50; camera.updateProjectionMatrix();
      if (controls){ controls.target.set(0,0,0); controls.update(); }
    }

    function onResize(){
      const {w,h} = size();
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w,h);
      controls && controls.update();
    }

    // ====== DOKU YÜKLEYİCİ ======
    const textureCache = new Map();
    function loadTexture(url){
      return new Promise((resolve,reject)=>{
        if (textureCache.has(url)) return resolve(textureCache.get(url));
        new THREE.TextureLoader().load(
          url,
          (tx)=>{
            // Doğal renkler ve düzgün kaplama
            tx.colorSpace = THREE.SRGBColorSpace;
            tx.wrapS = THREE.RepeatWrapping;
            tx.wrapT = THREE.RepeatWrapping;
            tx.center.set(0.5, 0.5);   // pivot
            tx.repeat.set(1,1);        // temel; parça bazında ayarlanacak
            tx.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy()||8);
            textureCache.set(url, tx);
            resolve(tx);
          },
          undefined,
          ()=>reject(new Error("Doku yüklenemedi: "+url))
        );
      });
    }

    async function buildMaterialFromKey(key){
      const path = MATERIAL_TEXTURES[key];
      if (path){
        try{
          const tx = await loadTexture(path);
          return new THREE.MeshStandardMaterial({ map: tx, roughness:0.6, metalness:0.05 });
        }catch(e){
          log(e.message + " → renk fallback");
        }
      }
      const color = MATERIAL_COLORS[key] || 0xcccccc;
      return new THREE.MeshStandardMaterial({ color, roughness:0.6, metalness:0.05 });
    }

    // Parça uygulaması: ölçek + yön aynı anda
    async function applyPart(partKey, matKey){
      const targets = partTargets[partKey] || [];
      if (!targets.length){ log(partKey+" için mesh bulunamadı."); return; }

      const mat = await buildMaterialFromKey(matKey);

      // Doku ayarı parça bazında
      const cfg = TEX_TWEAK[partKey] || {};
      if (mat.map){
        mat.map = mat.map.clone();  // diğer parçalardan bağımsız olsun
        const [ru, rv] = cfg.repeat || [1,1];
        mat.map.repeat.set(ru, rv);
        mat.map.center.set(0.5, 0.5);
        mat.map.rotation = ((cfg.rotDeg || 0) * Math.PI) / 180;
        mat.map.needsUpdate = true;
      }

      targets.forEach(m => { m.material = mat; m.material.needsUpdate = true; });
      log(`${partKey} → ${matKey}`);
    }

    // UI
    document.querySelectorAll('button[data-part]').forEach(btn=>{
      btn.addEventListener('click', ()=> applyPart(btn.dataset.part, btn.dataset.mat));
    });
    document.getElementById('applyUid').addEventListener('click', ()=>{
      const uid = document.getElementById('uidInput').value.trim();
      if (!uid) return;
      if (uid === "0001234567") applyPart("alt_panel","walnut"); // örnek
    });
  </script>
</body>
</html>

